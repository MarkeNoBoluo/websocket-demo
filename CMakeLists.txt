# WebSocket Demo - æ ¹CMakeé…ç½®
cmake_minimum_required(VERSION 3.16)

# ğŸ”§ è®¾ç½®CMakeç­–ç•¥ä»¥é¿å…è­¦å‘Š
if(POLICY CMP0144)
    cmake_policy(SET CMP0144 NEW)  # ä½¿ç”¨<PACKAGENAME>_ROOTå˜é‡
endif()

if(POLICY CMP0167)
    cmake_policy(SET CMP0167 OLD)  # ç»§ç»­ä½¿ç”¨FindBoostæ¨¡å—
endif()

project(WebSocketDemo
    VERSION 1.0.0
    DESCRIPTION "Modular WebSocket Client/Server Demo"
    LANGUAGES CXX
)
 
# ğŸ¯ è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# ğŸ“‚ è®¾ç½®è¾“å‡ºç›®å½•
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)

# ğŸ”§ åŒ…å«CMakeå·¥å…·è„šæœ¬
list(APPEND CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/cmake)

# ========== å¼ºåˆ¶æŒ‡å®šBoostè·¯å¾„ ==========
# æ¸…é™¤å¯èƒ½çš„CMakeç¼“å­˜å¹²æ‰°
unset(Boost_FOUND CACHE)
unset(Boost_INCLUDE_DIR CACHE)
unset(Boost_LIBRARY_DIRS CACHE)

set(Boost_ROOT "D:/LIB/Boost/boost_1_86_0")
set(BOOST_ROOT "D:/LIB/Boost/boost_1_86_0")
set(Boost_INCLUDE_DIR "D:/LIB/Boost/boost_1_86_0")
set(Boost_LIBRARY_DIR "D:/LIB/Boost/boost_1_86_0/stage/lib")
set(BOOST_LIBRARYDIR "D:/LIB/Boost/boost_1_86_0/stage/lib")
set(Boost_NO_SYSTEM_PATHS ON)
set(Boost_NO_BOOST_CMAKE ON)

# WebSocket++è·¯å¾„
set(WEBSOCKETPP_ROOT "D:/LIB/websocketpp")

# é…ç½®BoostæŸ¥æ‰¾é€‰é¡¹
set(Boost_USE_STATIC_LIBS OFF)
set(Boost_USE_MULTITHREADED ON)
set(Boost_USE_STATIC_RUNTIME OFF)
set(Boost_DETAILED_FAILURE_MSG ON)

find_package(Boost 1.86.0 REQUIRED
    COMPONENTS
        system
        thread
        chrono
        date_time
        random
    OPTIONAL_COMPONENTS
        context
        filesystem
)

if(Boost_FOUND)
    message(STATUS "âœ“ Boost ${Boost_VERSION} æ‰¾åˆ°")
    message(STATUS "  åŒ…å«ç›®å½•: ${Boost_INCLUDE_DIRS}")
    message(STATUS "  åº“ç›®å½•: ${Boost_LIBRARY_DIRS}")
else()
    message(FATAL_ERROR "âœ— æœªæ‰¾åˆ° Boost 1.86.0")
endif()

# ğŸ—ï¸ æŒ‰é¡ºåºæ·»åŠ æ¨¡å—ï¼ˆä¾èµ–é¡ºåºå¾ˆé‡è¦ï¼ï¼‰
add_subdirectory(common)      # 1. å…¬å…±åŸºç¡€åº“
add_subdirectory(core)        # 2. WebSocketæ ¸å¿ƒ
add_subdirectory(server)      # 3. æœåŠ¡å™¨ç¨‹åº
add_subdirectory(client)      # 4. å®¢æˆ·ç«¯åº“
add_subdirectory(console_client)  # 5. æ§åˆ¶å°å®¢æˆ·ç«¯

# Windowså¹³å°DLLå¤åˆ¶
if(WIN32 AND NOT Boost_USE_STATIC_LIBS)
    add_custom_target(copy_boost_dlls ALL
        COMMAND ${CMAKE_COMMAND} -E echo "å¤åˆ¶Boost DLL..."
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${Boost_LIBRARY_DIR}/boost_system-vc143-mt-x64-1_86.dll"
            "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}"
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${Boost_LIBRARY_DIR}/boost_thread-vc143-mt-x64-1_86.dll"
            "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}"
        COMMENT "å¤åˆ¶Boost DLLåˆ°è¾“å‡ºç›®å½•"
    )
endif()

# ğŸ’¡ æ„å»ºåä¿¡æ¯
message(STATUS "======================================")
message(STATUS "é¡¹ç›®é…ç½®å®Œæˆ")
message(STATUS "æ„å»ºç±»å‹: ${CMAKE_BUILD_TYPE}")
message(STATUS "è¾“å‡ºç›®å½•: ${CMAKE_BINARY_DIR}")
message(STATUS "======================================")
